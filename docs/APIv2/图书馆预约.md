# 图书馆预约

本文档描述了图书馆预约系统的基本概念、设置及接口。

2022年3月21日，应有关部门要求，在小风筝中添加图书馆预约接口。该功能仅针对奉贤校区。

受疫情影响，图书馆每周一、周二闭馆，每天分上午、下午两场预约，每场预约人数 295 人。为了响应后续需求变更，一些场次配置和限制需要在服务端进行， 同时提供公告接口以备用。

基本规则：

> 每日可以预约当日及次日座位。若当日未去，次日凭据应当作废。
>
> 每一个周期内可以多次出入馆，仅记录一次。

服务端通过 `GET /library/application/{apply_id}/code` 接口，返回预约详情和签名，用户端持该数据生成二维码备查，
管理端使用 `/library/publicKey` 提供的公钥验证签名。

场次规则：

> `period` 为一个整数，格式遵循如下规范：前 6 位表示年、月、日，最后 1 位表示场次（上午、下午）。
> 
> 如：2022年3月25日上午，即 `2203251`。

预约状态：

> 每一条预约记录包含 2 个状态：
> 0: `已预约`
> 1: `已入馆`。

## 接口

### GET /library/notice

查询图书馆公告。该接口只返回一条公告。

#### 权限

公共。

#### 响应示例

```json
{
  "code": 0,
  "data": {
    "ts": 1648193571,
    "html": "<p>文本</p><a href=\"#\">Link</a>"
  }
}
```

无公告时， `data` 字段返回 `null`。

```json
{
  "code": 0,
  "data": null
}
```

### GET /library/status/{date}/

查询图书馆某日场次和剩余座位情况。如果请求该接口时携带 token，接口将判断该用户是否预约过各场次，并返回相应的预约状态。
见响应中的 `appointed` 字段。

#### 权限

公共。

#### 参数

| 参数   | 类型     | 必填  | 释义     | 合法值          |
|------|--------|-----|--------|--------------|
| date | string | 是   | 要查询的日期 | 如 `20220301` |

#### 响应示例

```json
{
  "code": 0,
  "data": [
    {
      "period": 2203251,
      "count": 295,
      "applied": 200,
      "appointed": true,
      "text": "9:00 - 11:30"
    },
    {
      "period": 2203252,
      "count": 295,
      "applied": 200,
      "appointed": false,
      "text": "13:00 - 16:30"
    }
  ]
}
```

### GET /library/application/

查询预约记录。

#### 权限

已登录用户或管理员。

#### 参数

| 参数     | 类型     | 必填  | 释义      | 合法值            |
|--------|--------|-----|---------|----------------|
| period | int    | 否   | 场次      | 如 `2203251`    |
| user   | string | 否   | 用户学号/工号 | 如 `1910400123` |
| date   | string | 否   | 日期      | 如 `20220326`   |

普通用户仅允许查询自己的预约记录，管理员用户允许查询所有预约记录。

三个参数必填其一。

#### 响应示例

在一条预约记录中，`id` 表示数据主键，能唯一确定一条申请记录。 `index` 为本场次的预约序号，可能会影响到用户分配的房间位置。

```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "period": 2203251,
      "user": "1910400123",
      "index": 10,
      "text": "B201",
      "name": "姓名",
      "ts": "2022-03-25T22:59:25.792978+08:00",
      "status": 0
    },
    {
      "id": 2,
      "period": 2203252,
      "user": "1910400124",
      "index": 240,
      "text": "B206",
      "name": "姓名",
      "ts": "2022-03-25T22:59:25.792978+08:00",
      "status": 1
    }
  ]
}
```

`status` 表示该条预约记录的状态。可能的值为：GET /library/application/

- 0: 已预约但无进馆记录
- 1: 已标记为进馆


### GET /library/publicKey

获取 RSA 加密公钥。

#### 权限

所有用户。

#### 响应示例

```text
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA2r7YBPFGzRuLGXhCIiyv
YDdEt/LZ+Rb+x25NfPy2aedWcfBMJB8ksl/78M7X8Ra4pPL62lQ1qTeBwj7qReUf
WfErZ3y7rV5SeutL9GzD+dyPHc+waeB89ub8Wcvqo59IyR7JPAEFf4zGJGOFObd+
Rz78rID7/R3qAI4D+u3eB4dGzvdwv3xY1+wFY6Tnc0AhqgkHtbFbsPU/41b1Onzq
ExbiPs+wRTOqOPvPanpy//ErfNMiMtKxEtnWlIhKmlVnS6fgwzgHnUlVkcx9o2B6
igbE2jpAUWsJx2q+OtwtN+k1PaVFlfIrN2ZsE0EIAyj6rzCw6BCmDYzwWi2fvEZO
PQIDAQAB
-----END PUBLIC KEY-----
```

### GET /library/application/{apply_id}/code

获取预约详情及签名，管理端通过 `/library/publicKey` 返回的公钥验证签名。

#### 权限

已登录用户。

#### 响应示例

```json
{
  "code": 0,
  "data": {
    "application": {
      "id": 49,
      "index": 2,
      "period": 2203272,
      "status": 0,
      "ts": "2022-03-27T15:50:10.853492+08:00",
      "user": "1812100505"
    },
    "sign": "w1oIchL8mykY0V28K3UX9LVHYWxeK2zMy1k4DBlcthognEAzWsVnFsipHDMLhcGsBI5WBRWwEIe29gpqz+L9CYk7LZAXm7eR3Q2KMoDhVuwGeL+wzvf/+qbr2jTDxks/H9sB2xaaAs6HtX3tVCLIk3OPV3+t4hPbfWn1BgPTnLYUciyStFROF1HLjzsEqxko1Gc6VNlNMxm7zsDEMlDvIK5gdaYNKBVDo+rkXzJrDZ2NC9jIofG6lpBuYGO26ODmGv3Oc/b/eAmM/zAsAXEarLmhZdvTbZ16cvpFtj44cCDNEg8OOPH3g/32KlGCoN1HB99k7Tf60Cgobhb9PwYesA==",
    "timestamp": "2022-03-27T21:13:56.243845765+08:00"
  }
}
```

解密后的数据示例：

```json
{
  "application": {
    "id": 15,
    "period": 2203273,
    "user": "1910400740",
    "index": 1,
    "status": 0,
    "ts": "2022-03-26T10:12:07.855716+08:00"
  },
  "generation_ts": "2022-03-26T11:19:06.019350690+08:00"
}
```

### POST /library/application

申请座位。用户只能申请当天及次日座位。

#### 权限

已登录用户

#### 请求示例

```json
{
  "period": 2203251
}
```

#### 响应示例

```json
{
  "code": 0,
  "data": {
    "exist": false,
    "id": 27,
    "index": 1,
    "text": "B201"
  }
}
```

### PATCH /library/application/{apply_id}

更新预约状态。

#### 权限

管理员

#### 请求示例

将指定预约标记为 `已完成`。

```json
{
  "status": 1
}
```

#### 响应示例

```json
{
  "code": 0
}
```

### DELETE /library/application/{apply_id}

取消预约。

#### 权限

已登录用户或管理员

#### 响应示例

```json
{
  "code": 0
}
```


### GET /library/current

获取当前开放场次。

#### 权限

无验证。

#### 响应示例

```json
{
  "code": 0,
  "data": {
    "after": "2022-03-26T13:00:00+08:00",
    "before": "2022-03-26T16:00:00+08:00",
    "period": 2203262
  }
}
```

若当前不在开放时间，`period` 值为 `null`, 同时返回下一场次（不考虑闭馆的情况）。

示例如下：

```json
{
  "code": 0,
  "data": {
    "next": 2203271,
    "period": null
  }
}
```