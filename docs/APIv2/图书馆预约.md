# 图书馆预约

本文档描述了图书馆预约系统的基本概念、设置及接口。

2022年3月21日，应有关部门要求，在小风筝中添加图书馆预约接口。该功能仅针对奉贤校区。

受疫情影响，图书馆每周一、周二闭馆，每天分上午、下午两场预约，每场预约人数 295 人。为了响应后续需求变更，一些场次配置和限制需要在服务端进行， 同时提供公告接口以备用。

基本规则：

> 每日可以预约当日及次日座位。若当日未去，次日凭据应当作废。
>
> 每一个周期内可以多次出入馆，仅记录一次。

服务端通过 `GET /library/application/{apply_id}/code` 接口，生成 RSA 私钥加密后的数据，用户端持该数据生成二维码备查，且管理端可以使用公钥解密。

场次规则：

> `period` 为一个整数，格式遵循如下规范：前 6 位表示年、月、日，最后 1 位表示场次（上午、下午）。
> 
> 如：2022年3月25日上午，即 `2203251`。

预约状态：

> 每一条预约记录包含 2 个状态：
> 0: `已预约`
> 1: `已入馆`。

## 接口

### GET /library/notice

查询图书馆公告。该接口只返回一条公告。

#### 权限

公共。

#### 响应示例

```json
{
  "code": 0,
  "data": {
    "ts": 1648193571,
    "html": "<p>文本</p><a href=\"#\">Link</a>"
  }
}
```

### GET /library/available/

查询图书馆某日场次和剩余座位情况。

#### 权限

公共。

#### 参数

| 参数   | 类型     | 必填  | 释义     | 合法值          |
|------|--------|-----|--------|--------------|
| date | string | 是   | 要查询的日期 | 如 `2022-3-1` |

#### 响应示例

```json
{
  "code": 0,
  "data": [
    {
      "period": 2203251,
      "count": 295,
      "applied": 200,
      "text": "9:00 - 11:30"
    },
    {
      "period": 2203252,
      "count": 295,
      "applied": 200,
      "text": "13:00 - 16:30"
    }
  ]
}
```

### GET /library/application/

查询预约记录。

#### 权限

已登录用户或管理员。

#### 参数

| 参数     | 类型     | 必填  | 释义      | 合法值            |
|--------|--------|-----|---------|----------------|
| period | int    | 否   | 场次      | 如 `2203251`    |
| user   | string | 否   | 用户学号/工号 | 如 `1910400123` |

普通用户仅允许查询自己的预约记录，管理员用户允许查询所有预约记录。

两个参数必填其一。

#### 响应示例

```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "period": 2203251,
      "user": "1910400123",
      "status": 0
    },
    {
      "id": 2,
      "period": 2203252,
      "user": "1910400124",
      "status": 1
    }
  ]
}
```

`status` 表示该条预约记录的状态。可能的值为：GET /library/application/

- 0: 已预约但无进馆记录
- 1: 已标记为进馆

### GET /library/application/{apply_id}/code

获取加密后的二维码数据。

#### 权限

已登录用户。

#### 响应示例

```json
{
  "code": 0,
  "data": {
    "encrypted": "RSA 加密且 Base64 后的数据."
  }
}
```

### POST /library/application

申请座位。用户只能申请当天及次日座位。

#### 权限

已登录用户

#### 请求示例

```json
{
  "period": 2203251
}
```

#### 响应示例

```json
{
  "code": 0,
  "data": {
    "id": 2
  }
}
```

### UPDATE /library/application/{apply_id}

更新预约状态。

#### 权限

管理员

#### 请求示例

将指定预约标记为 `已完成`。

```json
{
  "status": 1
}
```

#### 响应示例

```json
{
  "code": 0
}
```

### DELETE /library/application/{apply_id}

取消预约。

#### 权限

已登录用户或管理员

#### 响应示例

```json
{
  "code": 0
}
```