## 一般流程

#### 已注册微信用户

1.  `POST /session` 通过微信提供的 `wxCode`，交换得到 `uid`
2. `GET /user/{uid}` 获得账户相关信息并进行后续操作

#### 未注册微信用户

1. `POST /session` 提交微信提供的 `wxCode`，服务端返回404
2. 小程序调用 `wx.getUserInfo` 方法，获得用户昵称、头像等信息。然后 `POST /user` 创建用户，得到 `uid`
3. 调用 `POST /user/{uid}/verification/0` 提交微信的 code 来绑定微信和刚创建的账户



## 约定

1. 调用接口无时间限制

2. 接口返回数据一般遵循如下格式：

   ```json
   {
       "code": xxx,
       "msg": xxx,
       "data": {
           // Something
       }
   }
   ```



## 接口

### [POST]   /session

创建会话（登录）。接口将返回一个 token，token无时间限制。这个接口是参考[一个帖子](https://www.v2ex.com/t/118049)设计的。

#### 参数

| 参数       | 类型   | 必填 | 释义               | 合法值                                    |
| ---------- | ------ | ---- | ------------------ | ----------------------------------------- |
| loginType  | int    | 是   | 登录方式           | 0 微信登录<br/>1 用户名密码登录（网页版） |
| account    | string | 否   | 用户名             | 仅用户名密码方式登录有效                  |
| credential | string | 否   | 密码               | 仅用户名密码方式登录有效                  |
| wxCode     | string | 否   | 微信的临时登录代码 | 仅微信登录有效                            |

#### 错误代码

| 代码 | 说明                                            |
| ---- | ----------------------------------------------- |
| 200  | 登录成功                                        |
| 400  | 请求错误，可能是缺少 loginType 字段，或参数越界 |
| 404  | 找不到用户                                      |
| 500  | 内部服务器错误，日志已记录                      |

#### 响应示例

```json
{
    "code": xxx,
    "msg": xxx,
    "data": {
        "uid": xxx,
        "token": xxx,
        "expiredTime": xxx, // 将来可能实现
    }
}
```



### [POST] /user/{uid}/verification/{loginType}

为指定用户创建登录渠道。支持本账户与管理员账户操作。

#### 参数

| 参数       | 类型   | 必填 | 释义               | 合法值                                    |
| ---------- | ------ | ---- | ------------------ | ----------------------------------------- |
| uid        | int    | 是   |                    |                                           |
| loginType  | int    | 是   | 登录方式           | 0 微信登录<br/>1 用户名密码登录（网页版） |
| account    | string | 否   | 用户名             | 仅用户名密码方式有效                      |
| credential | string | 否   | 密码               | 仅用户名密码方式有效                      |
| wxCode     | string | 否   | 微信的临时登录代码 | 仅微信绑定有效                            |

#### 错误代码

| 代码 | 说明                                         |
| ---- | -------------------------------------------- |
| 201  | 添加记录成功                                 |
| 400  | 请求错误，可能是缺少 `loginType`，`uid` 字段 |
| 403  | 账户已禁用，或请求的 `uid` 与 `token` 不符   |
| 404  | 找不到用户                                   |
| 500  | 内部服务器错误，日志已记录                   |

#### 响应示例

```json
{
    "code": xxx,
    "msg": xxx,
    "data": {}
}
```



### [GET] /user/{uid}/verification/{loginType}

获取绑定的登录方式，暂时不做



### [GET] /user/{uid}

获取用户相关数据。普通用户所带 token 只能获取自身账户信息，管理员组的用户无限制。

#### 参数

| 参数  | 类型   | 必填 | 释义     | 合法值            |
| ----- | ------ | ---- | -------- | ----------------- |
| uid   | int    | 是   | 用户ID   | int范围内的正整数 |
| token | string | 是   | 访问令牌 |                   |

#### 错误代码

| 代码 | 说明                                       |
| ---- | ------------------------------------------ |
| 200  | 正常响应                                   |
| 400  | 请求错误，可能是缺少字段，或参数不在范围内 |
| 403  | 账户已禁用，或请求的 `uid` 与 `token` 不符 |
| 404  | 找不到用户                                 |
| 500  | 内部服务器错误，日志已记录                 |

#### 响应示例

```json
{
    "code": xxx,
    "msg": xxx,
    "data": {
        "uid": xxx,
        "sex": xxx, // 用于在头像旁加标识
        "realName": xxx,
        "nickName": xxx,
        "avatar": "https://xxx", // 头像URL；可能来自腾讯也可能来自自建服务器
        "profile": xxx, // 个性签名，用于个人资料卡等
        "role": xxx,    // 1为管理员
        "country": xxx, // 本条等，为微信提供数据
        "province": xxx,
        "city": xxx,
    }
}
```



### [POST] /user

创建用户。接口设计参考了[一个讨论](https://stackoverflow.com/questions/7140074/restfully-design-login-or-register-resources)，该接口不需要提供 `uid` 参数。

#### 参数

| 参数       | 类型   | 必填 | 释义             | 合法值                 |
| ---------- | ------ | ---- | ---------------- | ---------------------- |
| token      | string | 是   | 访问令牌         |                        |
| sex        | int    | 否   | 性别             | 0 未知<br>1 男<br>2 女 |
| nick_name  | string | 否   | 昵称（微信昵称） |                        |
| avatar_url | string | 否   | 微信提供的头像   |                        |
| country    | string | 否   | 国家             |                        |
| province   | string | 否   | 省份             |                        |
| city       | string | 否   | 城市             |                        |

#### 错误代码

| 代码 | 说明                       |
| ---- | -------------------------- |
| 200  | 创建成功                   |
| 500  | 内部服务器错误，日志已记录 |

#### 响应示例

```json
{
    "code": xxx,
    "msg": xxx,
    "data": {
        "uid": xxx,
    }
}
```



### [GET] /user

获取用户列表。该接口目前只对管理员开放，并提供分页控制。分页参数未显式说明时，后端会提供默认值。（暂缓实现）

#### 参数

| 参数     | 类型   | 必填 | 释义     | 合法值       |
| -------- | ------ | ---- | -------- | ------------ |
| token    | string | 是   | 访问令牌 |              |
| pageSize | int    | 否   | 页大小   | 合理的正整数 |
| index    | int    | 否   | 页索引   | 合理的自然数 |

#### 错误代码

| 代码 | 说明                       |
| ---- | -------------------------- |
| 200  | 正常响应，哪怕无用户返回   |
| 403  | 权限不足                   |
| 500  | 内部服务器错误，日志已记录 |



### [UPDATE] /user/{uid}

更新用户信息。该接口存在与 `[GET] /user/{uid}` 相似的权限控制策略。

#### 参数

| 参数  | 类型   | 必填 | 释义     | 合法值            |
| ----- | ------ | ---- | -------- | ----------------- |
| uid   | int    | 是   | 用户ID   | int范围内的正整数 |
| token | string | 是   | 访问令牌 |                   |
| sex        | int    | 否   | 性别             | 0 未知<br>1 男<br>2 女 |
| nick_name  | string | 否   | 昵称（微信昵称） |                        |
| avatar_url | string | 否   | 微信提供的头像   |                        |
| country    | string | 否   | 国家             |                        |
| province   | string | 否   | 省份             |                        |
| city       | string | 否   | 城市             |                        |

#### 错误代码

| 代码 | 说明                                       |
| ---- | ------------------------------------------ |
| 200  | 正常响应                                   |
| 400  | 请求错误，可能是缺少字段，或参数不在范围内 |
| 403  | 账户已禁用，或请求的`uid` 与 `token` 不符  |
| 404  | 找不到用户                                 |
| 500  | 内部服务器错误，日志已记录                 |

#### 响应示例

```json
{
    "code": xxx,
    "msg": xxx,
    "data": {
        "uid": xxx,
        "sex": xxx, // 用于在头像旁加标识
        "realName": xxx,
        "nickName": xxx,
        "avatar": "https://xxx", // 头像URL；可能来自腾讯也可能来自自建服务器
        "profile": xxx, // 个性签名，用于个人资料卡等
        "role": xxx,    // 1为管理员
        "country": xxx, // 本条等，为微信提供数据
        "province": xxx,
        "city": xxx,
    }
}
```



### [DELETE] /user

短期内不计划做，因为没有必要。






### 错误代码

   一般遵循 HTTP Status Code（[HTTP 响应代码](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status)）。

