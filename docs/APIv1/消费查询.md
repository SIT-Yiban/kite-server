## 概念

消费查询包括**校园卡消费**与**宿舍电费**查询。

接口 | 说明
---- | ----
`/pay/room/{*roomId*}`            | 查询电费余额
`/pay/room/{*roomId*}/rank`       | 查询最近24小时电费用量排名
`/pay/room/{*roomId*}/bill/days`  | 查询几天内的每天用电情况
`/pay/room/{*roomId*}/bill/hours` | 查询最近一天的每小时用电情况

## 代码

- [`/src/services/handlers/pay.rs`][handler]
- [`/src/models/pay.rs`][model]

[handler]: https://github.com/SIT-Yiban/kite-server/blob/develop/src/services/handlers/pay.rs
[model]:   https://github.com/SIT-Yiban/kite-server/blob/develop/src/models/pay.rs

## 接口

### [GET] /pay/room/{*roomId*}

查询房间电费余额（仅支持奉贤校区）。

房间 ID 的计算规则是由电费查询系统规定的。格式为 “10” + 楼号 + 寝室号，如果遇到仅为个位的楼号，不补零。例如，对于1号楼101寝室（仅作示例，该寝室不存在），对应的房间 ID 为 `101101`。

余额更新可能有延迟，详见校内 OA [相关页面](card.sit.edu.cn)。

#### 权限

普通用户。

#### 参数

| 参数   | 类型   | 必填 | 释义   | 合法值 |
| ------ | ------ | ---- | ------ | ------ |
| roomId | string | 是   | 房间号 |        |

#### 响应示例

``` json
{
  "code": 0,
  "data": {
    "room": 101101,
    "balance": 25.012,
    "power": 41.68667,
    "ts": "1970-01-01T00:08:0000000+08:00"
}
}
```

### [GET] /pay/room/{*roomId*}/rank

查询房间用电量排行

#### 权限

普通用户。

#### 参数

| 参数   | 类型   | 必填 | 释义   | 合法值 |
| ------ | ------ | ---- | ------ | ------ |
| roomId | string | 是   | 房间号 |        |

#### 响应示例

``` json
{
  "code": 0,
  "data": {
    "consumption": 3.2330008,
    "rank": 1788,
    "room_count": 4565
  }
}
```

### [GET] /pay/room/{*roomId*}/bill/days

按日进行用电统计，所得数值均为正数。

#### 权限

普通用户。

#### 参数

| 参数   | 类型   | 必填 | 释义         | 合法值     |
| ------ | ------ | ---- | ------------ | ---------- |
| roomId | string | 是   | 房间号       |            |
| start  | string | 否   | 统计开始日期 | yyyy-MM-dd |
| end    | string | 否   | 统计结束日期 | yyyy-MM-dd |

1. 若某日数据在数据库中不存在，或该日未消费，接口会将该日消费量记为 0 以便前端使用
2. 若省略 `start`， 则默认从上周该日（7天前）的日期开始，若省略`end`，则默认为截止到今日

#### 响应示例

``` jsonc
{
  "code": 0,
  "data": [
    {
      "date": "2020-12-14",
      "charge": 0,
      "consumption": 2.5620003
    },
    {
      "date": "2020-12-15",
      "charge": 0,
      "consumption": 1.4029999
    } // ...
  ]
}
```


### [GET] /pay/room/{*roomId*}/bill/hours

统计最近一天各小时的用电量。

注意
1. 日期中的各个小时并非实际该小时产生的电费量，而是上一小时产生的电费量。
2. 该接口不支持指定时间范围

#### 权限

普通用户。

#### 参数

| 参数   | 类型   | 必填 | 释义   | 合法值 |
| ------ | ------ | ---- | ------ | ------ |
| roomId | string | 是   | 房间号 |        |

暂不支持指定起止时间。

#### 响应示例

``` json
{
  "code": 0,
  "data": [
    {
      "time": "2020-12-20 15:00",
      "charge": 0,
      "consumption": 0
    },
    {
      "time": "2020-12-20 16:00",
      "charge": 0,
      "consumption": 0.3050003
    },
    {
      "time": "2020-12-20 17:00",
      "charge": 0,
      "consumption": 0.24399948
    },
    {
      "time": "2020-12-20 18:00",
      "charge": 0,
      "consumption": 0.3050003
    },
    {
      "time": "2020-12-20 19:00",
      "charge": 0,
      "consumption": 0.24400139
    },
    {
      "time": "2020-12-20 20:00",
      "charge": 0,
      "consumption": 0.18299866
    },
    {
      "time": "2020-12-20 21:00",
      "charge": 0,
      "consumption": 0.18300056
    },
    {
      "time": "2020-12-20 22:00",
      "charge": 0,
      "consumption": 0.18300056
    },
    {
      "time": "2020-12-20 23:00",
      "charge": 0,
      "consumption": 0.24399948
    },
    {
      "time": "2020-12-21 00:00",
      "charge": 0,
      "consumption": 0.18300056
    },
    {
      "time": "2020-12-21 01:00",
      "charge": 0,
      "consumption": 060998917
    },
    {
      "time": "2020-12-21 02:00",
      "charge": 0,
      "consumption": 061000824
    },
    {
      "time": "2020-12-21 03:00",
      "charge": 0,
      "consumption": 060998917
    },
    {
      "time": "2020-12-21 04:00",
      "charge": 0,
      "consumption": 061000824
    },
    {
      "time": "2020-12-21 05:00",
      "charge": 0,
      "consumption": 0.12199974
    },
    {
      "time": "2020-12-21 06:00",
      "charge": 0,
      "consumption": 0
    },
    {
      "time": "2020-12-21 07:00",
      "charge": 0,
      "consumption": 061000824
    },
    {
      "time": "2020-12-21 08:00",
      "charge": 0,
      "consumption": 060998917
    },
    {
      "time": "2020-12-21 09:00",
      "charge": 0,
      "consumption": 061000824
    },
    {
      "time": "2020-12-21 10:00",
      "charge": 0,
      "consumption": 060998917
    },
    {
      "time": "2020-12-21 11:00",
      "charge": 0,
      "consumption": 061000824
    },
    {
      "time": "2020-12-21 12:00",
      "charge": 0,
      "consumption": 060998917
    },
    {
      "time": "2020-12-21 13:00",
      "charge": 0,
      "consumption": 0.12200165
    },
    {
      "time": "2020-12-21 14:00",
      "charge": 0,
      "consumption": 0.24399948
    },
    {
      "time": "2020-12-21 15:00",
      "charge": 0,
      "consumption": 0.24399948
    }
  ]
}

```

## 错误代码

| 代码 | 说明           | 内部解释     |
| ---- | -------------- | ------------ |
| 200  | 无对应房间数据 | `NoSuchRoom` |
