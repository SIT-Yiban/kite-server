## 概念

用户相关API有两个概念，User 和 Authentication，分别对应用户实体（Person）表和认证方式表。User 表示平台中用户实体，Authentication表示登录方式。

操作的资源主要有：

- /session 登录

- /user 创建账户，查询账户列表
- /user/{uid}/authentication/{loginType} 查询、创建、删除用户登录方式
- /user/{uid}  修改、禁用账户



## 一般流程

#### 已注册微信用户

1.  `POST /session` 通过微信提供的 `wxCode`，交换得到 `uid`
2. `GET /user/{uid}` 获得账户相关信息并进行后续操作

#### 未注册微信用户

1. `POST /session` 提交微信提供的 `wxCode`，服务端返回404
2. 小程序调用 `wx.getUserInfo` 方法，获得用户昵称、头像等信息。然后 `POST /user` 创建用户，得到 `uid`
3. 调用 `POST /user/{uid}/authentication/0` 提交微信的 code 来绑定微信和刚创建的账户



## 接口

### [POST]   /session

创建会话（登录）。接口将返回一个 token，token 目前无时间限制。这个接口是参考[一个帖子](https://www.v2ex.com/t/118049)设计的。

#### 权限

访客。

#### 参数

| 参数       | 类型   | 必填 | 释义               | 合法值                                    |
| ---------- | ------ | ---- | ------------------ | ----------------------------------------- |
| loginType  | int    | 是   | 登录方式           | 0 微信登录<br/>1 用户名密码登录（网页版） |
| account    | string | 否   | 用户名             | 仅用户名密码方式登录有效                  |
| credential | string | 否   | 密码               | 仅用户名密码方式登录有效                  |
| wxCode     | string | 否   | 微信的临时登录代码 | 仅微信登录有效                            |

#### 错误代码

| 代码 | 说明                           |
| ---- | ------------------------------ |
| 0    | 登录成功                       |
| 1    | 内部错误                       |
| 2    | 参数错误                       |
| 5    | 登录失败，凭据无效或找不到用户 |

#### 响应示例

```json
// 该 JWT secret 为测试用
{"code":0,"data":{"token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1aWQiOjF9.Ml5L2pPo4Tg0dJFYuz8niy_CR2gGagmfqJPYEiPSqlY"}}
```



### [POST] /user/{uid}/authentication

为指定用户创建登录渠道。

#### 权限

支持本账户与管理员账户操作。

#### 参数

| 参数       | 类型   | 必填 | 释义               | 合法值                                    |
| ---------- | ------ | ---- | ------------------ | ----------------------------------------- |
| uid        | int    | 是   |                    |                                           |
| loginType  | int    | 是   | 登录方式           | 0 微信登录<br/>1 用户名密码登录（网页版） |
| account    | string | 否   | 用户名             | 仅用户名密码方式有效                      |
| credential | string | 否   | 密码               | 仅用户名密码方式有效                      |
| wxCode     | string | 否   | 微信的临时登录代码 | 仅微信绑定有效                            |

#### 错误代码

| 代码 | 说明                                         |
| ---- | -------------------------------------------- |
| 0    | 添加记录成功                                 |
| 1    | 内部服务器错误，日志已记录                   |
| 2    | 参数错误，可能是缺少 `loginType`，`uid` 字段 |
| 5    | 找不到用户                                   |
| 6    | 账户已禁用                                   |

#### 响应示例

```json
{
    "code": 0,
    "msg": "OK",
    "data": {}
}
```



### [GET] /user/{uid}/verification/{loginType}

获取绑定的登录方式。

#### 权限

当前用户或管理员用户。

#### 参数

无其他参数

#### 错误代码

待定。



### [POST] /user

创建用户。接口设计参考了[一个讨论](https://stackoverflow.com/questions/7140074/restfully-design-login-or-register-resources)。

#### 权限

访客。

#### 参数

这里的参数名和微信返回的数据保持统一。见 wx.getUserInfo()

| 参数      | 类型   | 必填 | 释义             | 合法值                 |
| --------- | ------ | ---- | ---------------- | ---------------------- |
| gender    | int    | 否   | 性别             | 0 未知<br>1 男<br>2 女 |
| nickName  | string | 是   | 昵称（微信昵称） |                        |
| avatarUrl | string | 否   | 微信提供的头像   |                        |
| country   | string | 否   | 国家             |                        |
| province  | string | 否   | 省份             |                        |
| city      | string | 否   | 城市             |                        |
| language  | string | 否   | 使用语言（en等） |                        |

#### 错误代码

| 代码 | 说明                       |
| ---- | -------------------------- |
| 0    | 创建成功                   |
| 1    | 内部服务器错误，日志已记录 |
| 7    | 未知错误                   |

#### 响应示例

```json
{
    "code": 0,
    "msg": "ok",
    "data": {
        "uid": 2000,
    }
}
```



### [GET] /user

获取用户列表。

#### 权限

管理员。

#### 参数

| 参数     | 类型   | 必填 | 释义     | 合法值       |
| -------- | ------ | ---- | -------- | ------------ |
| token    | string | 是   | 访问令牌 |              |
| pageSize | int    | 否   | 页大小   | 合理的正整数 |
| index    | int    | 否   | 页索引   | 合理的自然数 |

#### 错误代码

| 代码 | 说明                       |
| ---- | -------------------------- |
| 0    | 正常响应，哪怕无用户返回   |
| 1    | 内部服务器错误，日志已记录 |
| 4    | 权限不足                   |



### [GET] /user/{uid}

获取用户相关数据。普通用户所带 token 只能获取自身账户信息，管理员组的用户无限制。

#### 参数

| 参数 | 类型 | 必填 | 释义   | 合法值 |
| ---- | ---- | ---- | ------ | ------ |
| uid  | int  | 是   | 用户ID | 正整数 |

#### 错误代码

| 代码 | 说明                                       |
| ---- | ------------------------------------------ |
| 0    | 正常响应                                   |
| 1    | 内部服务器错误，日志已记录                 |
| 2    | 请求错误，可能是缺少字段，或参数不在范围内 |
| 5    | 找不到用户                                 |
| 6    | 账户已禁用，或请求的 `uid` 与 `token` 不符 |

#### 响应示例

```json
{
    "code": 0,
    "msg": "OK",
    "data": {
        "uid": xxx,
        "sex": xxx, // 用于在头像旁加标识
        "realName": xxx,
        "nickName": xxx,
        "avatar": "https://xxx", // 头像URL；可能来自腾讯也可能来自自建服务器
        "profile": xxx, // 个性签名，用于个人资料卡等
        "role": xxx,    // 1为管理员
        "country": xxx, // 本条等，为微信提供数据
        "province": xxx,
        "city": xxx,
    }
}
```



### [UPDATE] /user/{uid}

更新用户信息。

#### 权限

当前用户或管理员用户。

#### 参数

| 参数  | 类型   | 必填 | 释义     | 合法值            |
| ----- | ------ | ---- | -------- | ----------------- |
| uid   | int    | 是   | 用户ID   | int范围内的正整数 |
| sex        | int    | 否   | 性别             | 0 未知<br>1 男<br>2 女 |
| nick_name  | string | 否   | 昵称（微信昵称） |                        |
| avatar_url | string | 否   | 微信提供的头像   |                        |
| country    | string | 否   | 国家             |                        |
| province   | string | 否   | 省份             |                        |
| city       | string | 否   | 城市             |                        |

#### 错误代码

| 代码 | 说明                                       |
| ---- | ------------------------------------------ |
| 0    | 正常响应                                   |
| 2    | 请求错误，可能是缺少字段，或参数不在范围内 |
| 6    | 账户已禁用，或请求的`uid` 与 `token` 不符  |
| 5    | 找不到用户                                 |
| 1    | 内部服务器错误，日志已记录                 |
| 11   | 头像存在敏感内容                           |
| 12   | 昵称存在敏感内容                           |

#### 响应示例

```json
{
    "code": xxx,
    "msg": xxx,
    "data": {
        "uid": xxx,
        "sex": xxx, // 用于在头像旁加标识
        "realName": xxx,
        "nickName": xxx,
        "avatar": "https://xxx", // 头像URL；可能来自腾讯也可能来自自建服务器
        "profile": xxx, // 个性签名，用于个人资料卡等
        "role": xxx,    // 1为管理员
        "country": xxx, // 本条等，为微信提供数据
        "province": xxx,
        "city": xxx,
    }
}
```



### [DELETE] /user/{uid}

删除某个账户。（后端具体实现方式可能为伪删除）

#### 权限

管理员账户。

#### 参数

无额外参数。

#### 错误代码

| 代码 | 说明                       |
| ---- | -------------------------- |
| 0    | 正常响应                   |
| 1    | 内部服务器错误，日志已记录 |
| 3    | 给定的 token 无效          |
| 4    | 权限不足                   |
| 5    | 找不到用户                 |
| 6    | 账户已删除（禁用）         |